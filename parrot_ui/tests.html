<html>
    <head>
        <style>.failure { color: red; } .success { color: green; }</style>

    </head>
    <body>
        <h3>Tests</h3>
        <div id="tests">

        </div>
        <script type="module">
            import { getSurroundingTopLevelExpr, getPrecedingExpr, getSymbolUnderOrBeforeCursor } from './scripts/utils.js'
            let el = document.getElementById('tests')

            //
            // This is a very simple test suite for some of the utility functions from utils.js
            // Which are mostly about selecting forms / expressions close to the cursor.
            //

            //
            // testing getSurroundingTopLevelExpr()
            //
            let testsGetSurroundingTopLevelExpr = [
                    ['', '', null],
                    [' ', ' ', null],
                    ['(test)', '', null],
                    ['(', ')', '()'],
                    ['(', 'test)', '(test)'],
                    ['(', '\ntest)', '(test)'],
                    ['(\n', 'test)', '(test)'],
                    ['()', '(test)', null],
                    ['))', 'test)', null],
                    [')', ')', null],
                    ['(defun test', ')', '(defun test)'],
                    ['(defun not)(defun not (defun not ()))(defun test', ')', '(defun test)'],
                    ['(defun not ()) (defun test', ')', '(defun test)'],
                    ['(defun not (',')) (defun test)', '(defun not ())'],
                    ['(defun test ()\n',' (nil))', '(defun test () (nil))'],
                    ['(defun dump-db () (format',' t "~{~{~a:~10t~a~%~}~%~}" *db*))', '(defun dump-db () (format t "~{~{~a:~10t~a~%~}~%~}" *db*))'],
                    ['(defun prompt-read (prompt) (format *query-io* ','"~a: " prompt) (force-output *query-io*) (read-line *query-io*))', '(defun prompt-read (prompt) (format *query-io* "~a: " prompt) (force-output *query-io*) (read-line *query-io*))'],
                    ['(defun prompt-read (prompt) (format *query-io* "~a: " prompt)',' (force-output *query-io*) (read-line *query-io*))', '(defun prompt-read (prompt) (format *query-io* "~a: " prompt) (force-output *query-io*) (read-line *query-io*))'],
                    ['(','defun prompt-read (prompt) (format *query-io* "~a: " prompt) (force-output *query-io*) (read-line *query-io*))', '(defun prompt-read (prompt) (format *query-io* "~a: " prompt) (force-output *query-io*) (read-line *query-io*))'],
                    ['(defun prompt-read (prompt) (format *query-io* "~a: " prompt) (force-output *query-io*) (read-line *query-io*)',')', '(defun prompt-read (prompt) (format *query-io* "~a: " prompt) (force-output *query-io*) (read-line *query-io*))'],
                ];
            for (let [before, after, expected] of testsGetSurroundingTopLevelExpr) {
                let actual = getSurroundingTopLevelExpr(before, after);
                if (actual) {
                    actual = actual.text;
                }
                el.innerHTML += `
                    <div>
                        getSurroundingTopLevelExpr('${before}', '${after}') = ${actual} ${actual === expected ? '<span class="success">Success</span>': '<span class="failure">Failure</span>'}
                    </div>
                `;
            }
            //
            // testing getPrecedingExpr()
            //
            let testsGetPrecedingExpr = [
                    ['', null],
                    [' ', null],
                    ['\n', null],
                    [' \n', null],
                    [' (+ 2 2)', '(+ 2 2)'],
                    ['2', '2'],
                    [' 2', '2'],
                    [' 2 ', '2'],
                    [' 2  ', '2'],
                    [' 22  ', '22'],
                    ['\t2  ', '2'],
                    ['\r\n2  ', '2'],
                    [') \r\n2  ', '2'],
                    ['(+ 3 3) 2', '2'],
                    ['(+ 3 3) (2)', '(2)'],
                    ['(defun test (format t "test"))', '(defun test (format t "test"))'],
                    ['(defun test ())', '(defun test ())'],
                    ['"a"\n"b"', '"b"'],
                    ['"a"\n"b" ', '"b"'],
                ];
            for (let [arg1, expected] of testsGetPrecedingExpr) {
                let actual = getPrecedingExpr(arg1);
                el.innerHTML += `
                    <div>
                        getPrecedingExpr('${arg1}') = ${actual ? "'"+actual+"'" : actual} ${actual === expected ? '<span class="success">Success</span>': ('<span class="failure">Failure: Expected = '+expected+'</span>')}
                    </div>
                `;
            }
            //
            // testing getSymbolUnderOrBeforeCursor()
            //
            let testsGetSymbolUnderOrBeforeCursor = [
                    ['', '', null],
                    [' ', '', null],
                    [' ', ' ', null],
                    ['\n', '', null],
                    ['', 'test', null],
                    ['(defun test', ' () ()', 'test'],
                    ['(defun test ', '() ()', 'test'],
                    ['(defun ', 'test () ()', 'defun'],
                    ['(defun', ' test () ()', 'defun'],
                    ['(defun test (arg1 arg2) (format t', ' "hola")', 't'],
                ];
            for (let [before, after, expected] of testsGetSymbolUnderOrBeforeCursor) {
                let actual = getSymbolUnderOrBeforeCursor(before, after);
                el.innerHTML += `
                    <div>
                        getSymbolUnderOrBeforeCursor('${before}', '${after}') = ${actual ? "'"+actual+"'" : actual} ${actual === expected ? '<span class="success">Success</span>': ('<span class="failure">Failure: Expected = '+expected+'</span>')}
                    </div>
                `;
            }


        </script>
    </body>
</html>'